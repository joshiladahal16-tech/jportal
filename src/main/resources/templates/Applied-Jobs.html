<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Applied Jobs · Job Portal</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
            rel="stylesheet"
    />
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- ✅ Correct for static root -->
    <link rel="stylesheet" th:href="@{/styles.css}" />
    <script th:src="@{/navbar.js}"></script>

    <meta
            name="description"
            content="Track your job applications and view status updates on our job portal."
    />
</head>
<body>
<header class="site-header">
    <div class="container nav">
        <a class="brand" th:href="@{/}"
        ><i class="fa-solid fa-briefcase"></i> Job Portal</a
        >
        <nav class="nav-links">
            <!-- Navbar will be populated by JavaScript -->
        </nav>
    </div>
</header>

<main class="section">
    <div class="container">
        <!-- Header Section -->
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem;">
            <div>
                <h1 style="margin: 0 0 0.6rem">Applied Jobs</h1>
                <p class="muted" style="margin: 0">
                    Track your applications and status updates.
                    <span th:if="${applications != null}"
                          th:text="'(' + ${applications.size()} + ' total applications)'">
                            (2 total applications)
                        </span>
                </p>
            </div>

            <!-- Filter and Actions -->
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <select id="statusFilter" onchange="filterApplications()" style="padding: 0.5rem; border-radius: 0.375rem;">
                    <option value="">All Status</option>
                    <option value="APPLIED">Applied</option>
                    <option value="UNDER_REVIEW">Under Review</option>
                    <option value="INTERVIEW">Interview</option>
                    <option value="OFFER">Offer</option>
                    <option value="REJECTED">Rejected</option>
                </select>
                <a class="btn btn-outline" th:href="@{/jobs}">
                    <i class="fa-solid fa-plus"></i> Find More Jobs
                </a>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="card">
            <!-- Check if applications exist -->
            <div th:if="${applications != null and !applications.isEmpty()}">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Role</th>
                        <th>Company</th>
                        <th>Applied Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="application : ${applications}"
                        th:data-status="${application.status}"
                        class="application-row">

                        <!-- Job Title -->
                        <td>
                            <div style="font-weight: 600;" th:text="${application.job.title}">UX Designer</div>
                            <div class="muted" style="font-size: 0.875rem;" th:text="${application.job.location}">Remote</div>
                        </td>

                        <!-- Company -->
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div th:if="${application.job.companyLogo != null}">
                                    <img th:src="${application.job.companyLogo}"
                                         th:alt="${application.job.company}"
                                         style="width: 32px; height: 32px; border-radius: 6px; object-fit: cover;" />
                                </div>
                                <div>
                                    <div style="font-weight: 500;" th:text="${application.job.company}">Sphere UI</div>
                                    <div class="muted" style="font-size: 0.875rem;" th:text="${application.job.type}">Full-time</div>
                                </div>
                            </div>
                        </td>

                        <!-- Applied Date -->
                        <td>
                            <div th:text="${#temporals.format(application.appliedDate, 'dd MMM yyyy')}">12 Aug 2025</div>
                            <div class="muted" style="font-size: 0.875rem;"
                                 th:text="${#temporals.format(application.appliedDate, 'HH:mm')}">10:30</div>
                        </td>

                        <!-- Status -->
                        <td>
                                    <span th:switch="${application.status}" class="badge">
                                        <span th:case="'APPLIED'"
                                              class="badge"
                                              style="background: #f3f4f6; border-color: #d1d5db; color: #374151;">
                                            Applied
                                        </span>
                                        <span th:case="'UNDER_REVIEW'"
                                              class="badge"
                                              style="background: #ecfeff; border-color: #a5f3fc; color: #155e75;">
                                            <i class="fa-solid fa-magnifying-glass"></i> Under Review
                                        </span>
                                        <span th:case="'INTERVIEW'"
                                              class="badge"
                                              style="background: #fef9c3; border-color: #fde68a; color: #854d0e;">
                                            <i class="fa-solid fa-calendar-check"></i> Interview
                                        </span>
                                        <span th:case="'OFFER'"
                                              class="badge"
                                              style="background: #dcfce7; border-color: #86efac; color: #15803d;">
                                            <i class="fa-solid fa-trophy"></i> Offer
                                        </span>
                                        <span th:case="'REJECTED'"
                                              class="badge"
                                              style="background: #fef2f2; border-color: #fca5a5; color: #dc2626;">
                                            <i class="fa-solid fa-times-circle"></i> Rejected
                                        </span>
                                        <span th:case="*"
                                              class="badge"
                                              style="background: #f3f4f6; border-color: #d1d5db; color: #374151;">
                                            Unknown
                                        </span>
                                    </span>
                        </td>

                        <!-- Actions -->
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <a class="btn btn-outline btn-sm"
                                   th:href="@{/jobs/{id}(id=${application.job.id})}"
                                   title="View Job Details">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                                <a class="btn btn-outline btn-sm"
                                   th:href="@{/applications/{id}(id=${application.id})}"
                                   title="View Application">
                                    <i class="fa-solid fa-file-alt"></i>
                                </a>
                                <button class="btn btn-outline btn-sm"
                                        th:if="${application.status == 'APPLIED' or application.status == 'UNDER_REVIEW'}"
                                        onclick="withdrawApplication([[${application.id}]])"
                                        title="Withdraw Application"
                                        style="color: #dc2626; border-color: #dc2626;">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div th:unless="${applications != null and !applications.isEmpty()}"
                 style="text-align: center; padding: 3rem 1rem;">
                <i class="fa-solid fa-briefcase" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                <h3 style="margin: 0 0 0.5rem; color: #374151;">No Applications Yet</h3>
                <p class="muted" style="margin: 0 0 1.5rem;">
                    You haven't applied to any jobs yet. Start exploring opportunities!
                </p>
                <a class="btn btn-primary" th:href="@{/jobs}">
                    <i class="fa-solid fa-search"></i> Browse Jobs
                </a>
            </div>
        </div>

        <!-- Application Statistics -->
        <div th:if="${applications != null and !applications.isEmpty()}"
             class="grid grid-4" style="margin-top: 1.5rem;">
            <div class="card" style="text-align: center; padding: 1rem;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #7b43f6;"
                     th:text="${applicationStats != null ? applicationStats.totalApplications : applications.size()}">2</div>
                <div class="muted">Total Applied</div>
            </div>
            <div class="card" style="text-align: center; padding: 1rem;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;"
                     th:text="${applicationStats != null ? applicationStats.interviewCount : 0}">1</div>
                <div class="muted">Interviews</div>
            </div>
            <div class="card" style="text-align: center; padding: 1rem;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;"
                     th:text="${applicationStats != null ? applicationStats.rejectedCount : 0}">0</div>
                <div class="muted">Rejected</div>
            </div>
            <div class="card" style="text-align: center; padding: 1rem;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #ea580c;"
                     th:text="${applicationStats != null ? applicationStats.pendingCount : applications.size()}">2</div>
                <div class="muted">Pending</div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="footer">
    <div class="footer-container">
        <!-- Logo / About -->
        <div class="footer-section about">
            <h2 class="footer-logo"><i class="fa-solid fa-fire"></i> Hot Jobs</h2>
            <p>
                Your trusted platform for high-intent job openings hand-picked daily.
            </p>
        </div>

        <!-- Quick Links -->
        <div class="footer-section links">
            <h3>Quick Links</h3>
            <ul>
                <li><a th:href="@{/}">Home</a></li>
                <li><a th:href="@{/jobs}">Browse Jobs</a></li>
                <li><a th:href="@{/employer/post-job}">Post a Job</a></li>
                <li><a th:href="@{/contact}">Contact</a></li>
            </ul>
        </div>

        <!-- Resources -->
        <div class="footer-section resources">
            <h3>Resources</h3>
            <ul>
                <li><a th:href="@{/blog}">Blog</a></li>
                <li><a th:href="@{/faq}">FAQs</a></li>
                <li><a th:href="@{/support}">Support</a></li>
                <li><a th:href="@{/privacy}">Privacy Policy</a></li>
            </ul>
        </div>

        <!-- Social -->
        <div class="footer-section social">
            <h3>Follow Us</h3>
            <div class="social-icons">
                <a href="#"><i class="fa-brands fa-facebook"></i></a>
                <a href="#"><i class="fa-brands fa-twitter"></i></a>
                <a href="#"><i class="fa-brands fa-linkedin"></i></a>
                <a href="#"><i class="fa-brands fa-instagram"></i></a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <p>© 2025 Hot Jobs. All Rights Reserved.</p>
    </div>
</footer>

<!-- JavaScript Functions -->
<script>
    // Filter applications by status
    function filterApplications() {
        const filterValue = document.getElementById('statusFilter').value;
        const rows = document.querySelectorAll('.application-row');

        rows.forEach(row => {
            if (filterValue === '' || row.dataset.status === filterValue) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Withdraw application
    function withdrawApplication(applicationId) {
        if (confirm('Are you sure you want to withdraw this application? This action cannot be undone.')) {
            // Send withdrawal request
            fetch(`/applications/${applicationId}/withdraw`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reload page to show updated status
                    window.location.reload();
                } else {
                    alert('Error withdrawing application. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error withdrawing application. Please try again.');
            });
        }
    }

    // Auto-refresh status every 30 seconds
    setInterval(() => {
        // Only refresh if user is actively viewing the page
        if (document.visibilityState === 'visible') {
            fetch('/applications/status-updates', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.hasUpdates) {
                    // Show notification about updates
                    showUpdateNotification();
                }
            })
            .catch(error => console.error('Status update check failed:', error));
        }
    }, 30000);

    function showUpdateNotification() {
        const notification = document.createElement('div');
        notification.innerHTML = `
            <div style="position: fixed; top: 20px; right: 20px; background: #7b43f6; color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
                <i class="fa-solid fa-bell"></i> Application status updated!
                <button onclick="window.location.reload()" style="background: none; border: 1px solid white; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; cursor: pointer;">
                    Refresh
                </button>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 0.5rem; cursor: pointer;">×</button>
            </div>
        `;
        document.body.appendChild(notification);

        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 10000);
    }
</script>

<!-- Styles -->
<style>
    .footer {
        background: #1a1a1a;
        color: #eee;
        padding: 2rem 1.5rem 1rem;
        margin-top: 2rem;
        font-family: Arial, sans-serif;
    }
    .footer-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 2rem;
        max-width: 1100px;
        margin: auto;
    }
    .footer-section h3,
    .footer-logo {
        margin-bottom: 1rem;
        color: #fff;
    }
    .footer-logo {
        font-size: 20px;
        font-weight: bold;
        color: #8b5cf6;
    }
    .footer-section ul {
        list-style: none;
        padding: 0;
    }
    .footer-section ul li {
        margin: 0.5rem 0;
    }
    .footer-section ul li a {
        color: #ccc;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    .footer-section ul li a:hover {
        color: #8b5cf6;
    }
    .footer .social-icons a {
        color: #ccc;
        margin-right: 10px;
        font-size: 18px;
        transition: color 0.2s ease;
    }
    .footer .social-icons a:hover {
        color: #8b5cf6;
    }
    .footer-bottom {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #333;
        font-size: 14px;
        color: #aaa;
    }

    /* Table enhancements */
    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th,
    .table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    .table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #374151;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Button enhancements */
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .btn-outline:hover {
        background-color: #7b43f6;
        color: white;
        border-color: #7b43f6;
    }

    /* Grid utilities */
    .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .grid-4 {
            grid-template-columns: 1fr;
        }

        .table {
            font-size: 0.875rem;
        }

        .table th,
        .table td {
            padding: 0.5rem;
        }
    }

    /* Badge styling */
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid;
    }

    /* Responsive table */
    @media (max-width: 768px) {
        .table-wrapper {
            overflow-x: auto;
        }
    }

    /* Loading state */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Status indicators */
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }

    .status-applied .status-dot { background-color: #6b7280; }
    .status-under-review .status-dot { background-color: #0891b2; }
    .status-interview .status-dot { background-color: #d97706; }
    .status-offer .status-dot { background-color: #059669; }
    .status-rejected .status-dot { background-color: #dc2626; }
</style>
</body>
</html>